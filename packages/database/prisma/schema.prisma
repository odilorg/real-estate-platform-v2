generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User profile with role for authentication
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  firstName     String
  lastName      String
  phone         String?
  role          UserRole  @default(USER)
  isOAuthUser   Boolean   @default(false)
  banned        Boolean   @default(false)
  banReason     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  properties    Property[]
  favorites     Favorite[]
  reviews       Review[]
  viewingsRequested Viewing[] @relation("ViewingRequester")
  viewingsOwned     Viewing[] @relation("ViewingOwner")
  savedSearches SavedSearch[]
  recentlyViewed RecentlyViewed[]
  agent         Agent?
  adminLogs     AdminLog[]
  propertyViews PropertyView[]
  priceChanges  PriceHistory[]

  @@index([email])
  @@index([role])
}

enum UserRole {
  USER
  AGENT
  ADMIN
}

// Property model - main listing entity
model Property {
  id          String        @id @default(cuid())
  userId      String
  title       String
  description String
  price       Float
  priceUsd    Float?         // Normalized price in USD for search
  currency    Currency      @default(YE)
  propertyType PropertyType
  listingType ListingType
  status      PropertyStatus @default(ACTIVE)

  // Location details
  address     String
  city        String
  state       String?
  country     String        @default("Uzbekistan")
  zipCode     String?
  latitude    Float?
  longitude   Float?
  district    String?
  mahalla     String?
  nearestMetro String?
  metroDistance Int?

  // Property details - Areas
  bedrooms    Int?
  bathrooms   Float?
  area        Float?
  livingArea  Float?
  kitchenArea Float?
  rooms       Int?

  // Property details - Building info
  yearBuilt   Int?
  floor       Int?
  totalFloors Int?
  ceilingHeight Float?

  // Property details - Features
  parking     Int?
  parkingType ParkingType?
  balcony     Int?
  loggia      Int?

  // Building characteristics
  buildingType  BuildingType?
  buildingClass BuildingClass?
  buildingName  String?
  elevatorPassenger Int?
  elevatorCargo     Int?
  hasGarbageChute   Boolean @default(false)
  hasConcierge      Boolean @default(false)
  hasGatedArea      Boolean @default(false)

  // Apartment condition
  renovation    RenovationType?
  windowView    String?
  bathroomType  String?
  furnished     String?

  // Metadata
  views       Int           @default(0)
  featured    Boolean       @default(false)
  verified    Boolean       @default(false)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  images      PropertyImage[]
  amenities   PropertyAmenity[]
  favorites   Favorite[]
  reviews     Review[]
  viewings    Viewing[]
  conversations Conversation[]
  analytics   PropertyAnalytics[]
  propertyViews PropertyView[]
  priceHistory PriceHistory[]

  @@index([userId])
  @@index([city])
  @@index([propertyType])
  @@index([listingType])
  @@index([status])
  @@index([price])
  @@index([buildingClass])
  // Composite indexes for common search patterns (performance optimization)
  @@index([status, city, propertyType])
  @@index([status, city, listingType, price])
  @@index([status, propertyType, listingType, price])
  @@index([status, city, bedrooms, price])
  @@index([latitude, longitude, status])
  @@index([status, createdAt])
  @@index([status, featured, createdAt])
  @@index([userId, status, createdAt])
}

enum PropertyType {
  APARTMENT
  HOUSE
  CONDO
  TOWNHOUSE
  LAND
  COMMERCIAL
}

enum ListingType {
  SALE
  RENT_LONG
  RENT_DAILY
}

enum Currency {
  YE    // ั.ะต. (conditional units - standard in Uzbekistan)
  UZS   // Uzbek Som
}

enum PropertyStatus {
  ACTIVE
  PENDING
  SOLD
  RENTED
  INACTIVE
}

enum BuildingType {
  BRICK
  PANEL
  MONOLITHIC
  WOOD
  BLOCK
}

enum BuildingClass {
  ECONOMY
  COMFORT
  BUSINESS
  ELITE
}

enum RenovationType {
  NONE
  COSMETIC
  EURO
  DESIGNER
  NEEDS_REPAIR
}

enum ParkingType {
  STREET
  UNDERGROUND
  GARAGE
  MULTI_LEVEL
}

// Property images
model PropertyImage {
  id          String    @id @default(cuid())
  propertyId  String
  url         String
  order       Int       @default(0)
  isPrimary   Boolean   @default(false)
  createdAt   DateTime  @default(now())

  property    Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
}

// Amenities/Features
model PropertyAmenity {
  id          String    @id @default(cuid())
  propertyId  String
  amenity     String

  property    Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([propertyId, amenity])
  @@index([propertyId])
}

// Favorites/Wishlist
model Favorite {
  id          String    @id @default(cuid())
  userId      String
  propertyId  String
  createdAt   DateTime  @default(now())

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  property    Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([userId, propertyId])
  @@index([userId])
  // Composite index for performance
  @@index([userId, createdAt])
}

// Conversation model for messaging
model Conversation {
  id            String    @id @default(cuid())
  propertyId    String
  participant1Id String
  participant2Id String
  lastMessageAt DateTime  @default(now())
  createdAt     DateTime  @default(now())

  property      Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  messages      Message[]

  @@unique([propertyId, participant1Id, participant2Id])
  @@index([participant1Id])
  @@index([participant2Id])
}

// Messaging system
model Message {
  id             String       @id @default(cuid())
  conversationId String
  senderId       String
  content        String
  read           Boolean      @default(false)
  createdAt      DateTime     @default(now())

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
  // Composite indexes for performance
  @@index([conversationId, createdAt])
  @@index([conversationId, read, senderId])
}

// Reviews and ratings
model Review {
  id          String    @id @default(cuid())
  propertyId  String
  userId      String
  rating      Int
  comment     String
  approved    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  property    Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([propertyId, userId])
  @@index([propertyId])
  @@index([userId])
  // Composite index for performance
  @@index([propertyId, approved, createdAt])
}

// Saved searches
model SavedSearch {
  id                   String    @id @default(cuid())
  userId               String
  name                 String
  filters              Json
  notificationsEnabled Boolean   @default(false)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Viewing appointments/scheduling
model Viewing {
  id          String        @id @default(cuid())
  propertyId  String
  requesterId String
  ownerId     String
  date        DateTime
  time        String
  status      ViewingStatus @default(PENDING)
  message     String?
  notes       String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  property    Property      @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  requester   User          @relation("ViewingRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  owner       User          @relation("ViewingOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([requesterId])
  @@index([ownerId])
  @@index([date])
}

enum ViewingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

// Recently viewed properties
model RecentlyViewed {
  id          String    @id @default(cuid())
  userId      String
  propertyId  String
  viewedAt    DateTime  @default(now())

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, propertyId])
  @@index([userId])
  @@index([viewedAt])
}

// Real Estate Agency
model Agency {
  id              String    @id @default(cuid())
  name            String
  slug            String    @unique
  logo            String?
  description     String?
  website         String?
  email           String?
  phone           String?
  address         String?
  city            String?
  yearsOnPlatform Int       @default(0)
  verified        Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  agents          Agent[]

  @@index([slug])
  @@index([city])
}

// Real Estate Agent
model Agent {
  id              String    @id @default(cuid())
  userId          String    @unique
  agencyId        String?

  firstName       String
  lastName        String
  photo           String?
  bio             String?
  phone           String?
  email           String?
  whatsapp        String?
  telegram        String?

  licenseNumber   String?
  specializations String[]
  languages       String[]
  areasServed     String[]

  yearsExperience Int       @default(0)
  totalDeals      Int       @default(0)
  verified        Boolean   @default(false)
  superAgent      Boolean   @default(false)
  responseTime    String?
  rating          Float     @default(0)
  reviewCount     Int       @default(0)

  showPhone       Boolean   @default(true)
  showEmail       Boolean   @default(true)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  agency          Agency?   @relation(fields: [agencyId], references: [id])
  reviews         AgentReview[]

  @@index([userId])
  @@index([agencyId])
  @@index([superAgent])
  @@index([verified])
}

// Agent Reviews
model AgentReview {
  id          String    @id @default(cuid())
  agentId     String
  userId      String
  rating      Int
  comment     String?
  dealType    String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  agent       Agent     @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, userId])
  @@index([agentId])
  @@index([userId])
}

// Admin action log for audit trail
model AdminLog {
  id          String    @id @default(cuid())
  adminId     String
  action      String
  targetType  String
  targetId    String
  details     Json?
  createdAt   DateTime  @default(now())

  admin       User      @relation(fields: [adminId], references: [id])

  @@index([adminId])
  @@index([action])
  @@index([createdAt])
}

// Property Analytics tracking
model PropertyAnalytics {
  id          String    @id @default(cuid())
  propertyId  String
  date        DateTime  @default(now())

  // Daily metrics
  views       Int       @default(0)
  favorites   Int       @default(0)
  unfavorites Int       @default(0)
  contacts    Int       @default(0)

  // Price tracking
  price       Float?
  priceUsd    Float?

  property    Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([propertyId, date])
  @@index([propertyId])
  @@index([date])
}

// Property view tracking (individual views)
model PropertyView {
  id          String    @id @default(cuid())
  propertyId  String
  userId      String?
  ipAddress   String?
  userAgent   String?
  referrer    String?
  createdAt   DateTime  @default(now())

  property    Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([propertyId])
  @@index([userId])
  @@index([createdAt])
  @@index([propertyId, createdAt])
}

// Nearby amenities for properties
model NearbyAmenity {
  id          String       @id @default(cuid())
  name        String
  type        AmenityType
  latitude    Float
  longitude   Float
  address     String?
  city        String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([type])
  @@index([city])
  @@index([latitude, longitude])
}

enum AmenityType {
  METRO
  BUS_STOP
  SCHOOL
  KINDERGARTEN
  HOSPITAL
  PHARMACY
  SUPERMARKET
  SHOPPING_MALL
  RESTAURANT
  CAFE
  PARK
  GYM
  BANK
}

// Price history tracking for properties
model PriceHistory {
  id          String    @id @default(cuid())
  propertyId  String
  oldPrice    Float
  newPrice    Float
  currency    Currency
  changedBy   String?
  createdAt   DateTime  @default(now())

  property    Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user        User?     @relation(fields: [changedBy], references: [id], onDelete: SetNull)

  @@index([propertyId])
  @@index([createdAt])
  @@index([propertyId, createdAt])
  @@map("price_history")
}
