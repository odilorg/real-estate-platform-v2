name: Test Secrets Configuration

on:
  workflow_dispatch: # Manual trigger only

jobs:
  test-secrets:
    name: Verify Secrets & VPS Connection
    runs-on: ubuntu-latest

    steps:
      - name: Check if secrets exist
        run: |
          echo "Testing if secrets are configured..."

          if [ -z "${{ secrets.VPS_HOST }}" ]; then
            echo "‚ùå VPS_HOST is missing"
            exit 1
          else
            echo "‚úÖ VPS_HOST is set"
          fi

          if [ -z "${{ secrets.VPS_PORT }}" ]; then
            echo "‚ùå VPS_PORT is missing"
            exit 1
          else
            echo "‚úÖ VPS_PORT is set"
          fi

          if [ -z "${{ secrets.VPS_USER }}" ]; then
            echo "‚ùå VPS_USER is missing"
            exit 1
          else
            echo "‚úÖ VPS_USER is set"
          fi

          if [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "‚ùå VPS_SSH_KEY is missing"
            exit 1
          else
            echo "‚úÖ VPS_SSH_KEY is set"
          fi

          if [ -z "${{ secrets.DATABASE_URL }}" ]; then
            echo "‚ùå DATABASE_URL is missing"
            exit 1
          else
            echo "‚úÖ DATABASE_URL is set"
          fi

          if [ -z "${{ secrets.JWT_SECRET }}" ]; then
            echo "‚ùå JWT_SECRET is missing"
            exit 1
          else
            echo "‚úÖ JWT_SECRET is set"
          fi

          echo ""
          echo "üéâ All secrets are configured!"

      - name: Test VPS SSH Connection
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "‚úÖ SSH connection successful!"
            echo "Server: $(hostname)"
            echo "OS: $(cat /etc/os-release | grep PRETTY_NAME)"
            echo "Node version: $(node --version)"
            echo "PM2 version: $(pm2 --version)"
            echo "PostgreSQL: $(psql --version)"
            echo ""
            echo "App directory exists:"
            ls -la /var/www/realestate-staging || echo "Directory doesn't exist yet"

      - name: Summary
        if: success()
        run: |
          echo "‚úÖ All secrets verified successfully!"
          echo "‚úÖ SSH connection works!"
          echo "‚úÖ VPS is ready for deployment!"
